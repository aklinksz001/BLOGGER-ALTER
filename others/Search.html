<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Search Movies</title>

  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/Search.css">

  <!-- Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.basic.min.js"></script>

  <style>
    :root{
      --bg: #fbfbfc;
      --card-bg: #ffffff;
      --muted: #667085;
      --accent: linear-gradient(90deg,#ff6b6b,#ff9a6b);
      --accent-solid: #ff6b6b;
      --green: #0b9b50;
      --shadow-sm: 0 4px 12px rgba(16,24,40,0.06);
      --shadow-lg: 0 10px 30px rgba(16,24,40,0.10);
      --radius: 12px;
    }

    html,body{
      height:100%;
      margin:0;
      background: var(--bg);
      color:#0f1724;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:40px;
    }

    .page { max-width:980px; margin:22px auto; padding:0 14px; }

    .search-area { display:flex; flex-direction:column; gap:10px; margin-bottom:14px; }

    .search-wrap { display:flex; align-items:center; gap:12px; width:100%; }

    #searchBar {
      width:100%;
      padding:14px 18px;
      font-size:16px;
      border-radius: 14px;
      border: none;
      outline: none;
      box-shadow: var(--shadow-sm);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.95));
      color: #0f1724;
      transition: box-shadow .15s ease, transform .08s ease;
      -webkit-appearance:none;
    }

    #searchBar:focus{ box-shadow: var(--shadow-lg); transform: translateY(-1px); }

    .controls-row { display:flex; gap:12px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }

    #refreshIndex {
      padding:10px 14px; border-radius: 10px; border: none; cursor:pointer;
      background: var(--accent); color: #fff; font-weight:700;
      box-shadow: 0 6px 18px rgba(255,105,105,0.14);
    }
    #refreshIndex[disabled]{ opacity:.6; cursor:not-allowed; box-shadow:none; }

    .control-secondary {
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#fff;
      border-radius:10px; border:1px solid rgba(15,23,36,0.04); box-shadow: var(--shadow-sm);
      color: var(--muted); font-weight:600; font-size:14px;
    }
    .control-secondary input[type="checkbox"]{ width:18px; height:18px; margin:0; accent-color: var(--accent-solid); }

    #searchMeta { margin-top:6px; color:var(--muted); font-size:13px; }

    main#searchResults { margin-top:10px; display:flex; flex-direction:column; gap:10px; }

    .card {
      position: relative; /* IMPORTANT: for card-level tag positioning */
      display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit;
      border-radius: 14px; background: var(--card-bg); padding:10px;
      border: 1px solid rgba(15,23,36,0.03); box-shadow: 0 6px 18px rgba(16,24,40,0.04);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .card:hover{ transform: translateY(-4px); box-shadow: var(--shadow-lg); }

    .thumb-wrap { flex:0 0 140px; max-width:35%; position:relative; }
    .thumb { width:100%; height:0; padding-bottom:56.25%; border-radius:10px; background-position:center; background-size:cover; box-shadow: inset 0 -6px 18px rgba(0,0,0,0.06); }

    /* TAG PILL AT CARD TOP-RIGHT (bigger, card-level) */
    .tag-pill {
      position: absolute;
      bottom: 0;
      right: 0;
      background: linear-gradient(180deg,#fff0ec,#ffe7e3);
      color: #c23a2f;
      padding: 3px 5px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 9px;      /* bigger font per your request */
      letter-spacing: 0.2px;
      border: 1px solid rgba(194,58,47,0.12);
      box-shadow: 0 4px 12px rgba(194,58,47,0.10);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      line-height: 1;
      z-index: 5;
    }

    .tag-pill .plus-count {
      background: rgba(0,0,0,0.08);
      padding: 1px 3px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      color: #4e4e4e;
    }

    .details { flex:1; display:flex; flex-direction:column; justify-content:center; min-height:64px; padding-right:6px; }
    .title { font-weight:800; color:#081126; margin:0; line-height:1.1; font-size: clamp(13px, 1.9vw, 17px); letter-spacing: 0.1px; }
    .meta-row { margin-top:8px; display:flex; gap:8px; align-items:center; font-size:13px; }
    .badge { display:inline-block; background: linear-gradient(180deg,#f5faf5,#ffffff); padding:6px 9px; border-radius:999px; color: #0b9b50; font-weight:800; font-size:12px; border: 1px solid rgba(4,107,47,0.06); box-shadow: 0 2px 6px rgba(11,155,80,0.04); }

    .no-results { padding:14px; color:var(--muted); background:linear-gradient(180deg,#fff,#fbfbfb); border-radius:10px; border:1px dashed rgba(15,23,36,0.04); }

    @media (max-width:640px){
      .page{ margin:12px auto; padding:0 12px; }
      .thumb-wrap { flex:0 0 110px; max-width:40%; }
      .controls-row{ justify-content:center; }
      .control-secondary{ font-size:13px; padding:7px 10px; }
      #refreshIndex { padding:9px 12px; font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="page">

    <!-- Search area: single-line search; controls below -->
    <section class="search-area" aria-labelledby="search-heading">
      <div class="search-wrap">
        <input id="searchBar" type="text" placeholder="Search movies, languages or year — e.g. Avengers 2012" aria-label="Search movies">
      </div>

      <div class="controls-row" role="group" aria-label="Search controls">
        <button id="refreshIndex" title="Reload JSON index">Refresh Index</button>

        <div class="control-secondary" style="gap:10px;">
          <input id="strictToggle" type="checkbox" aria-label="Strict mode">
          <div style="display:flex;flex-direction:column;">
            <span style="font-weight:800;color:#0f1724;font-size:13px;">Strict mode</span>
            <span style="font-size:12px;color:var(--muted);margin-top:2px;">Fewer fuzzy results</span>
          </div>
        </div>

        <div style="margin-left:auto; align-self:center;">
          <div style="color:var(--muted); font-size:13px;">Tip: Use full titles for precise matches</div>
        </div>
      </div>

      <div id="searchMeta" aria-live="polite">Index loading…</div>
    </section>

    <!-- Results -->
    <main id="searchResults" role="list"></main>
  </div>

  <!-- Autofocus from index -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (sessionStorage.getItem("focusSearch") === "true") {
        const searchBar = document.getElementById("searchBar");
        if (searchBar) { searchBar.focus(); searchBar.select(); }
        sessionStorage.removeItem("focusSearch");
      }
    });
  </script>

  <!-- Main script (Fuse + UI + tags) -->
  <script>
    // ========== CONFIG: update these JSON file paths ==========
    const jsonFiles = [
      "../posts/index1.json",
      "../posts/index2.json",
      "../posts/1500-Webseries/index.json"
    ];

    const fuseBaseOptions = {
      keys: [
        { name: "title", weight: 0.7 },
        { name: "language", weight: 0.2 },
        { name: "year", weight: 0.1 },
        { name: "tags", weight: 0.15 } // include tags
      ],
      includeScore: true,
      ignoreLocation: true,
      minMatchCharLength: 1
    };

    // ========== STATE ==========
    let allItems = [];
    let fuse = null;
    let isLoaded = false;

    // ========== HELPERS ==========
    function escapeHtml(unsafe) {
      return String(unsafe || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function debounce(fn, wait = 180) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    function buildFuse(threshold = 0.35) {
      const opts = Object.assign({}, fuseBaseOptions, { threshold });
      fuse = new Fuse(allItems, opts);
    }

    // Create tag pill helper (card-level)
    function createTagPill(tagsArr) {
      if (!Array.isArray(tagsArr) || tagsArr.length === 0) return null;

      const pill = document.createElement("div");
      pill.className = "tag-pill";

      const first = document.createElement("span");
      const label = String(tagsArr[0] || "");
      first.textContent = label.length > 14 ? label.slice(0, 14) + "…" : label;
      pill.appendChild(first);

      if (tagsArr.length > 1) {
        const more = document.createElement("span");
        more.className = "plus-count";
        more.textContent = `+${tagsArr.length - 1}`;
        pill.appendChild(more);
      }
      return pill;
    }

    // ========== LOAD & INDEX ==========
    async function preloadJSON() {
      isLoaded = false;
      allItems = [];

      const promises = jsonFiles.map(async (path) => {
        try {
          const res = await fetch(path, { cache: "no-store" });
          if (!res.ok) throw new Error(`Failed to load ${path}: ${res.status}`);
          const json = await res.json();
          const items = Array.isArray(json.items) ? json.items : [];
          return items.map(it => ({
            title: String(it.title || "Unknown Title").trim(),
            img: String(it.img || "").trim(),
            language: String(it.language || "UNKNOWN").replace(/^Language:\s*/i, "").trim().toUpperCase(),
            link: String(it.link || "#").trim(),
            year: it.year ? String(it.year).trim() : "",
            // normalize tags
            tags: (() => {
              if (!it.tags) return [];
              if (Array.isArray(it.tags)) return it.tags.map(t => String(t).trim()).filter(Boolean);
              return String(it.tags).split(",").map(s => s.trim()).filter(Boolean);
            })()
          }));
        } catch (err) {
          console.error(`Error loading ${path}:`, err);
          return [];
        }
      });

      const results = await Promise.all(promises);
      const flat = results.flat();

      // Deduplicate by link
      const seen = new Set();
      for (const it of flat) {
        if (!seen.has(it.link)) {
          seen.add(it.link);
          allItems.push(it);
        }
      }

      buildFuse();
      isLoaded = true;
      console.info(`Index built: ${allItems.length} items`);
      updateMeta(0);
    }

    async function refreshIndex() {
      const btn = document.getElementById("refreshIndex");
      if (btn) { btn.disabled = true; btn.innerText = "Refreshing..."; }
      try { await preloadJSON(); } catch (e) { console.error("Refresh failed:", e); }
      finally { if (btn) { btn.disabled = false; btn.innerText = "Refresh Index"; } }
    }

    // ========== SEARCH ==========
    function searchQuery(q, maxResults = 200, strict = false) {
      if (!isLoaded || !fuse) return [];
      const query = String(q || "").trim();
      if (!query) return [];

      buildFuse(strict ? 0.20 : 0.35);

      const raw = fuse.search(query, { limit: maxResults });
      return raw.map(r => r.item);
    }

    // ========== UI ==========
    function updateMeta(count) {
      const meta = document.getElementById("searchMeta");
      if (!meta) return;
      if (!isLoaded) meta.textContent = "Index loading…";
      else meta.textContent = count ? `${count} result${count === 1 ? "" : "s"}` : `Index ready — ${allItems.length} items`;
    }

    function shrinkTitleToFit(titleEl, minSize = 12, maxSize = 17) {
      if (!titleEl) return;
      titleEl.style.fontSize = maxSize + "px";
      const maxLines = 2;
      const lineHeight = parseFloat(getComputedStyle(titleEl).lineHeight || (maxSize * 1.15));
      const maxHeight = lineHeight * maxLines + 2;

      let size = maxSize;
      while ((titleEl.scrollWidth > titleEl.clientWidth || titleEl.scrollHeight > maxHeight) && size > minSize) {
        size -= 1;
        titleEl.style.fontSize = size + "px";
        if (size <= minSize) break;
      }
    }

    function showResults(results) {
      const container = document.getElementById("searchResults");
      if (!container) return;
      container.innerHTML = "";

      if (!results || results.length === 0) {
        updateMeta(0);
        container.innerHTML = `<div class="no-results">No results found</div>`;
        return;
      }

      updateMeta(results.length);

      const frag = document.createDocumentFragment();
      results.forEach(item => {
        const safeTitle = escapeHtml(item.title);
        const safeImg = escapeHtml(item.img);
        const safeLink = escapeHtml(item.link);
        const safeLanguage = escapeHtml(item.language || "UNKNOWN");
        const safeYear = escapeHtml(item.year || "");
        const tags = Array.isArray(item.tags) ? item.tags : [];

        const a = document.createElement("a");
        a.className = "card";
        a.href = safeLink;
        a.target = "_self";
        a.setAttribute("role", "listitem");

        const thumbWrap = document.createElement("div");
        thumbWrap.className = "thumb-wrap";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        thumb.style.backgroundImage = `url('${safeImg}')`;
        thumbWrap.appendChild(thumb);

        const details = document.createElement("div");
        details.className = "details";

        const title = document.createElement("div");
        title.className = "title";
        title.innerHTML = safeTitle;

        const metaRow = document.createElement("div");
        metaRow.className = "meta-row";
        if (safeYear) { const y = document.createElement("div"); y.className = "badge"; y.textContent = safeYear; metaRow.appendChild(y); }
        const lang = document.createElement("div"); lang.className = "badge"; lang.textContent = safeLanguage; metaRow.appendChild(lang);

        details.appendChild(title);
        details.appendChild(metaRow);

        a.appendChild(thumbWrap);
        a.appendChild(details);

        // append tag pill to the card container (card-level positioning)
        const pill = createTagPill(tags);
        if (pill) a.appendChild(pill);

        frag.appendChild(a);
      });

      container.appendChild(frag);

      requestAnimationFrame(() => {
        const titles = container.querySelectorAll(".card .title");
        titles.forEach(t => shrinkTitleToFit(t, 12, 17));
      });
    }

    // ========== WIRING ==========
    function attachHandlers() {
      const searchBar = document.getElementById("searchBar");
      const refreshBtn = document.getElementById("refreshIndex");
      const strictToggle = document.getElementById("strictToggle");

      const onInput = debounce(() => {
        if (!searchBar) return;
        const q = searchBar.value || "";
        if (!q.trim()) {
          updateMeta(0);
          document.getElementById("searchResults").innerHTML = "";
          return;
        }
        const strict = strictToggle ? strictToggle.checked : false;
        const results = searchQuery(q, 300, strict);
        showResults(results);
      }, 160);

      if (searchBar) {
        searchBar.addEventListener("input", onInput);
        searchBar.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const q = searchBar.value || "";
            const strict = strictToggle ? strictToggle.checked : false;
            const results = searchQuery(q, 300, strict);
            showResults(results);
          }
        });
      }

      if (refreshBtn) refreshBtn.addEventListener("click", refreshIndex);
    }

    // ========== INIT ==========
    (async function init() {
      attachHandlers();
      updateMeta(0);
      await preloadJSON();
    })();
  </script>
</body>
</html>
